"use strict";angular.module("chunky",["ngRoute","ui.bootstrap"]).config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/main.html"}).otherwise({redirectTo:"/"})}]).service("chunkySynth",["audioCtx","Oscillator","Filter","Envelope","Distortion","Reverb","LFO","Noise",function(a,b,c,d,e,f,g,h){var i=function(a){var i=this;this.ctx=a,this.osc1=new b(this.ctx,"sawtooth",4,0,-10),this.osc2=new b(this.ctx,"sawtooth",3,0,10),this.osc3=new b(this.ctx,"square",1,0),this.noise=new h(this.ctx),this.vcf=new c(this.ctx,{type:"bandpass"}),this.vcf2=new c(this.ctx,{type:"highpass"}),this.vcfEnvelope=new d(this.ctx),this.vcaEnvelope=new d(this.ctx),this.env1=new d(this.ctx),this.env2=new d(this.ctx),this.lfo=new g(this.ctx),this.distortion=new e(this.ctx),this.reverb=new f(this.ctx),this.master=this.ctx.createGain(),this.analyser=this.ctx.createAnalyser(),this.oscs=[this.osc1,this.osc2,this.osc3],this.envelopes=[this.vcfEnvelope,this.vcaEnvelope,this.env1,this.env2],this.vcf.input.gain.value=.5,this.vcf2.input.gain.value=.5,this._vcfmix=.5,this.analyser.fftSize=2048,this.master.gain.value=1,this.vcfEnvelope.connect(this.vcf,["_filter","frequency"]),this.vcfEnvelope.connect(this.vcf2,["_filter","frequency"]),this.vcaEnvelope.connect(this.master,"gain"),angular.forEach(this.oscs,function(a){a.connect(i.vcf.input),a.connect(i.vcf2.input)}),this.noise.connect(this.vcf.input),this.noise.connect(this.vcf2.input),this.vcf.connect(this.distortion.input),this.vcf2.connect(this.distortion.input),this.distortion.connect(this.reverb),this.reverb.connect(this.master),this.master.connect(this.analyser),this.analyser.connect(this.ctx.destination),this.init()};return i.prototype=Object.create(null,{init:{value:function(){return angular.forEach(this.oscs,function(a){a.init()}),this}},play:{value:function(){return this.vcfEnvelope.triggerOn(),this.vcaEnvelope.triggerOn(),this.noise.start(),angular.forEach(this.oscs,function(a){a.start()}),this}},playNote:{value:function(a){return this.vcfEnvelope.triggerOn(),this.vcaEnvelope.triggerOn(),this.noise.start(),angular.forEach(this.oscs,function(b){b.frequency=a,b.start()}),this}},stop:{value:function(){return this.vcfEnvelope.triggerOff(),this.vcaEnvelope.triggerOff(),this.noise.stop(),angular.forEach(this.oscs,function(a){a.stop()}),this}},vcfMix:{enumberable:!0,get:function(){return this._vcfMix},set:function(a){this._vcfMix=a,this.vcf.input.gain.value=parseFloat(a),this.vcf2.input.gain.value=parseFloat(1-a)}}}),new i(a)}]).controller("chunkyController",["$scope","chunkySynth",function(a,b){a.chunky=b,a.keyboard={keydown:function(b,c){a.chunky.playNote(c)},keyup:function(){a.chunky.stop()}}}]),angular.module("chunky").directive("knob",["$document",function(a){return{restrict:"EA",replace:!0,template:'<div class="knob"><p data-ng-if="label" data-ng-bind="label" class="label"></p><div class="knob-face"><div class="knob-moving-face"><div class="knob-hand"></div></div></div><canvas class="knob-progress"></canvas></div>',scope:{value:"=",label:"@",options:"=",min:"=",max:"=",speed:"=",scale:"="},link:function(b,c){function d(a){o.clickpos=a.pageY||a.originalEvent.targetTouches[0].pageY,o.focus=!0,o.initdeg=l.data("degs"),c.data("md",!0)}function e(a){var d=a.pageY||a.originalEvent.targetTouches[0].pageY,e=l.data("degs"),f=(o.clickpos-d)*h.speed,g=f*v+e;p>g&&g>q?e=g:g>p?e=p:q>g&&(e=q),e>q?c.addClass("turned-on"):c.removeClass("turned-on"),l.data("degs",e),l.css("-webkit-transform","rotate("+e+"deg)"),l.css("-moz-transform","rotate("+e+"deg)"),l.css("-ms-transform","rotate("+e+"deg)"),l.css("-o-transform","rotate("+e+"deg)"),l.css("transform","rotate("+e+"deg)");var i=l.data("degs")+p,j=Math.round(i/t*u);j+=h.min*u,j/=u,b.$apply(function(){b.value=parseFloat(j.toFixed(2))}),r=a.pageY||a.originalEvent.targetTouches[0].pageY,a.preventDefault()}function f(){o.focus=!1,l.data("md",!1)}var g={range:270,"class":b.options["class"]||"knob-default",responsive:b.options.responsive||!1,min:b.options.min||0,max:b.options.max||100,speed:b.options.speed||.5,scale:b.options.scale||1,holdKey:!1,groupKey:!1},h=g,i=h.range/2,j=c,k=c.find(".knob-face"),l=k.find(".knob-moving-face"),m=l.find(".knob-hand"),n=j.find(".knob-progress");j.addClass(h["class"]),l.css("position","relative").css("overflow","hidden").css("float","none").css("-webkit-transform","rotate("+-i+"deg)").css("-moz-transform","rotate("+-i+"deg)").css("-ms-transform","rotate("+-i+"deg)").css("-o-transform","rotate("+-i+"deg)").css("transform","rotate("+-i+"deg)").data("degs",-i).data("value",0).data("md",!1).css("z-index","29"),k.css("float","none"),n.css("position","absolute").css("top",0).css("left",0).css("width",0).css("z-index","0"),h.responsive&&(j.addClass("knob-responsive"),k.css("height",k.width()));l.width()/2-m.width()/2;m.css("position","absolute").css("left","15px").css("height",l.innerHeight()/2);var o={},p=h.range/2,q=-1*p,r=0,s=h.max-h.min,t=h.range/s,u=1/h.scale,v=h.range/(h.max-h.min)*h.scale;o.clickPos=0,o.focus=!1,o.holdKey=!1,o.groupKey=!1,o.initDeg=0,l.on("touchstart",function(a){d(a)}),a.on("touchmove",function(a){o.focus&&(e(a,!0),b.$apply())}),a.on("touchend",function(){f()}),l.on("mousedown",function(a){d(a)}),a.on("mousemove",function(a){o.focus&&(e(a,!1),b.$apply())}),a.on("mouseup",function(){f()})}}}]),angular.module("chunky").directive("keyboard",["$window",function(a){return{restrict:"EA",scope:{keyup:"&",keydown:"&"},link:function(b,c){var d=new QwertyHancock({id:c.id,width:a.window.innerWidth,height:150,octaves:2,startNote:"C0"}),e=function(a){return 0===Object.keys(a).length},f={};d.keyDown=function(a,c){b.$apply(function(){b.keydown()(a,c),f[a]=!0})},d.keyUp=function(a,c){b.$apply(function(){delete f[a],e(f)&&b.keyup()(a,c)})}}}}]),angular.module("chunky").directive("oscilloscope",function(){return{restrict:"EA",template:"<canvas></canvas>",replace:!0,scope:{analyser:"="},link:function(a,b){var c=b.parent(),d=b[0],e=d.getContext("2d"),f=a.analyser.fftSize,g=new Uint8Array(f);d.width=c[0].offsetWidth,a.analyser.getByteTimeDomainData(g);var h=function(){requestAnimationFrame(h);a.analyser.getByteTimeDomainData(g),e.fillStyle="rgb(200, 200, 200)",e.fillRect(0,0,d.width,d.height),e.lineWidth=2,e.strokeStyle="rgb(0, 0, 0)",e.beginPath();for(var b=10*d.width/f,c=0,i=0;f>i;i++){var j=g[i]/128,k=j*d.height/2;0===i?e.moveTo(c,k):e.lineTo(c,k),c+=b}e.lineTo(d.width,d.height/2),e.stroke()};h()}}}),angular.module("chunky").directive("envelope",["$window",function(){return{restrict:"EA",template:"<canvas></canvas>",replace:!0,scope:{params:"="},link:function(a,b){function c(){requestAnimationFrame(c);e.clearRect(0,0,f,g),e.lineWidth=2,e.beginPath(),e.moveTo(h*(1-a.params.attack),g),e.lineTo(f/4,0),e.lineTo(h*(a.params.decay+1),g*(1-a.params.sustain)),e.lineTo(3*h,g*(1-a.params.sustain)),e.lineTo(h*(a.params.release+3),g),e.strokeStyle="rgb(196,221,232)",e.stroke()}var d=b,e=(b.parent(),d[0].getContext("2d")),f=d[0].width,g=d[0].height,h=f/4;d.css("background-color","rgba(9,12,21,0.6)").css("border","1px solid rgb(57,64,72)").css("margin-top","5px"),c()}}}]),angular.module("chunky").directive("killRightClick",["$document",function(a){return{restrict:"CA",link:function(){a.on("contextmenu",function(a){a.preventDefault()})}}}]),angular.module("chunky").service("audioCtx",["$window",function(){var a=window.AudioContext||window.webkitAudioContext||window.mozAudioContext||window.oAudioContext||window.msAudioContext;return a?new a:void 0}]),angular.module("chunky").factory("Oscillator",function(){var a=function(a,b,c,d,e){this.ctx=a,this.osc=a.createOscillator(),this.controlNode=a.createGain(),this.node=this.ctx.createGain(),this.output=a.createGain(),this._frequencyKey=d||55,this._octave=c||2,this._fine=e||0,this._frequency=Math.pow(2,this._octave*this.frequencyKey),this.osc.type=b,this.osc.frequency.value=this._frequency,this.osc.detune.value=this._fine,this.controlNode.gain.value=.5,this.node.gain.value=0,this.output.gain.value=0,this.osc.connect(this.controlNode),this.controlNode.connect(this.node),this.node.connect(this.output),this._enabled=!1};return a.prototype=Object.create(null,{connect:{value:function(a){this.output.connect(a.input?a.input:a)}},disconnect:{value:function(){this.output.disconnect()}},init:{value:function(){this.osc.start(0)}},start:{value:function(){var a=this.ctx.currentTime;return this.output.gain.setValueAtTime(1,a),this}},stop:{value:function(a){a=a||0;var b=this.ctx.currentTime;return this.output.gain.setValueAtTime(0,b+a),this}},frequency:{enumerable:!0,get:function(){return this.osc.frequency.value},set:function(a){this._frequencyKey=a,this._frequency=Math.pow(2,this.octave)*this._frequencyKey,this.osc.frequency.setValueAtTime(this._frequency,0)}},octave:{enumerable:!0,get:function(){return this._octave},set:function(a){this._octave=a}},fine:{enumerable:!0,get:function(){return this._fine},set:function(a){this._fine=a,this.osc.detune.setValueAtTime(this._fine,0)}},gain:{enumerable:!0,get:function(){return this.controlNode.gain.value},set:function(a){this.controlNode.gain.setValueAtTime(a,0)}},enabled:{enumerable:!0,get:function(){return this._enabled},set:function(a){this._enabled=a,this._enabled?this.node.gain.setValueAtTime(1,0):this.node.gain.setValueAtTime(0,0)}}}),a}),angular.module("chunky").factory("Noise",function(){var a={white:function(a){var b,c;for(b=a.outputBuffer.getChannelData(0),c=0;c<b.length;c++)b[c]=2*Math.random()-1},pink:function(a){var b,c,d,e,f,g,h,i,j,k;for(b=c=d=e=f=g=h=0,i=a.outputBuffer.getChannelData(0),k=0;k<i.length;k++)j=2*Math.random()-1,b=.99886*b+.0555179*j,c=.99332*c+.0750759*j,d=.969*d+.153852*j,e=.8665*e+.3104856*j,f=.55*f+.5329522*j,g=-.7616*g-.016898*j,i[k]=b+c+d+e+f+g+h+.5362*j,i[k]*=.11,h=.115926*j},brown:function(a){var b,c,d,e;for(b=a.outputBuffer.getChannelData(0),d=0,e=0;e<b.length;e++)c=2*Math.random()-1,b[e]=(d+.02*c)/1.02,d=b[e],b[e]*=3.5}},b=function(b,c){c=c||{},this.ctx=b,this.node=this.ctx.createScriptProcessor(2048,1,1),this._wet=this.ctx.createGain(),this._controlGain=this.ctx.createGain(),this.output=this.ctx.createGain(),this._enabled=!1,this._type=c.type||"white",this._wet.gain.value=0,this.output.gain.value=0,this.node.onaudioprocess=a[this._type],this.node.connect(this._wet),this._wet.connect(this._controlGain),this._controlGain.connect(this.output)};return b.prototype=Object.create(null,{connect:{value:function(a){this.output.connect(a)}},disconnect:{value:function(){this.output.disconnect()}},start:{value:function(){this.output.gain.setValueAtTime(1,0)}},stop:{value:function(){this.output.gain.setValueAtTime(0,0)}},gain:{enumerable:!0,get:function(){return this._controlGain.gain.value},set:function(a){this._controlGain.gain.setValueAtTime(a,0)}},enabled:{enumerable:!0,get:function(){return this._enabled},set:function(a){this._enabled=a,this._enabled?this._wet.gain.setValueAtTime(1,0):this._wet.gain.setValueAtTime(0,0)}},type:{enumerable:!0,get:function(){return this._type},set:function(b){this._type=b,this.node.onaudioprocess=a[b]}}}),b.White=function(a){var c={};return c.onaudioprocess=function(a){var b,c;for(b=a.outputBuffer.getChannelData(0),c=0;c<b.length;c++)b[c]=2*Math.random()-1},new b(a,c)},b.Pink=function(a){var c={};return c.onaudioprocess=function(a){var b,c,d,e,f,g,h,i,j,k;for(b=c=d=e=f=g=h=0,i=a.outputBuffer.getChannelData(0),j=2*Math.random()-1,k=0;k<i.length;k++)b=.99886*b+.0555179*j,c=.99332*c+.0750759*j,d=.969*d+.153852*j,e=.8665*e+.3104856*j,f=.55*f+.5329522*j,g=-.7616*g-.016898*j,i[k]=b+c+d+e+f+g+h+.5362*j,i[k]*=.11,h=.115926*j},new b(a,c)},b.Brown=function(a){var c={};return c.onaudioprocess=function(a){var b,c,d,e;for(b=a.outputBuffer.getChannelData(0),c=2*Math.random()-1,d=0,e=0;e<b.length;e++)b[e]=(d+.02*c)/1.02,d=b[e],b[e]*=3.5},new b(a,c)},b}),angular.module("chunky").factory("Filter",function(){var a=function(a,b){this.ctx=a,this.input=this.ctx.createGain(),this.output=this.ctx.createGain(),this._filter=this.ctx.createBiquadFilter(),this._dry=this.ctx.createGain(),this._wet=this.ctx.createGain();var c=this.meta.params;b=b||{},this._type=b.type||c.type.defaultValue,this._filter.frequency.value=b.frequency||c.frequency.defaultValue,this._filter.Q.value=b.resonance||c.resonance.defaultValue,this._filter.gain.value=b.gain||c.gain.defaultValue,this._wet.gain.value=b.wet||c.wet.defaultValue,this._dry.gain.value=b.dry||c.dry.defaultValue,this._filter.type=this._type,this.input.connect(this._filter),this._filter.connect(this._wet),this._wet.connect(this.output),this.input.connect(this._dry),this._dry.connect(this.output),this._enabled=!0,this._envelope=void 0};return a.prototype=Object.create(null,{connect:{value:function(a){this.output.connect(a)}},disconnect:{value:function(){this.output.disconnect()}},meta:{value:{params:{frequency:{min:30,max:22050,defaultValue:300,type:"float"},resonance:{min:1e-4,max:20,defaultValue:1,type:"float"},gain:{min:-40,max:40,defaultValue:1,type:"float"},wet:{min:0,max:1,defaultValue:1,type:"float"},dry:{min:0,max:1,defaultValue:0,type:"float"}}}},envelope:{enumerable:!0,get:function(){return this._envelope},set:function(a){this._envelope=a,this._envelope.range=[80,25e3*Math.pow(this.frequency/1e3,2)+80]}},frequency:{enumerable:!0,get:function(){return this._filter.frequency.value},set:function(a){this._filter.frequency.setValueAtTime(a,0),this._envelope&&this._envelope.range&&(this._envelope.range=[80,25e3*Math.pow(a/1e3,2)+80])}},resonance:{enumerable:!0,get:function(){return this._filter.Q.value},set:function(a){this._filter.Q.setValueAtTime(a,0)}},gain:{enumerable:!0,get:function(){return this._filter.gain.value},set:function(a){this._filter.gain.setValueAtTime(a,0)}},wet:{enumerable:!0,get:function(){return this._wet.gain.value},set:function(a){this._wet.gain.setValueAtTime(a,0)}},dry:{enumerable:!0,get:function(){return this._dry.gain.value},set:function(a){this._dry.gain.setValueAtTime(a,0)}},enabled:{enumerable:!0,get:function(){return this._enabled},set:function(a){this._enabled=a,this._enabled?(this._dry.gain.setValueAtTime(0,0),this._wet.gain.setValueAtTime(1,0)):(this._dry.gain.setValueAtTime(1,0),this._wet.gain.setValueAtTime(0,0))}}}),a}),angular.module("chunky").factory("Envelope",function(){var a=function(a){this.ctx=a,this.min=0,this.max=1,this._attack=.02,this._decay=1,this._sustain=1,this._release=.02,this.params=[]};return a.prototype=Object.create(null,{connect:{value:function(a,b,c){var d,e=this;a.envelope=e,d=angular.isArray(b)?a[b[0]][b[1]]:a[b],this.params.push({parent:a,target:d,meta:c})}},disconnect:{value:function(){}},adsr:{get:function(){return[this._attack,this._decay,this._sustain,this._release]},set:function(a){this._attack=a[0]/5e4,this._decay=a[0]/5e4,this._sustain=a[0]/100,this._release=a[0]/5e4}},attack:{get:function(){return this._attack},set:function(a){this._attack=a/5e4}},decay:{get:function(){return this._decay},set:function(a){this._decay=a/5e4}},sustain:{get:function(){return this._sustain},set:function(a){this._sustain=a/100}},release:{get:function(){return this._release},set:function(a){this._release=a/5e4}},range:{get:function(){return[this.min,this.max]},set:function(a){this.min=a[0],this.max=a[1]}},triggerOn:{value:function(){var a=this.ctx.currentTime,b=this;angular.forEach(this.params,function(c){var d=parseFloat(a+b.attack),e=parseFloat(b.min),f=parseFloat(b.max);c.target.cancelScheduledValues(a),c.target.setValueAtTime(0,a),c.target.linearRampToValueAtTime(f,d),c.target.linearRampToValueAtTime(b.sustain*(f-e)+e,d+b.decay)})}},triggerOff:{value:function(){var a=this.ctx.currentTime,b=this;angular.forEach(this.params,function(c){c.target.linearRampToValueAtTime(0,a+parseFloat(b.release)),c.target.linearRampToValueAtTime(0,a+parseFloat(b.release)+.01),c.target.cancelScheduledValues(0,a+parseFloat(b.release)+.02)})}}}),a}),angular.module("chunky").factory("LFO",["Oscillator",function(a){var b=function(b){this.lfo=new a(b,"sine",0,5),this.output=b.createGain(),this.lfo.connect(this.output),this.init()};return b.prototype=Object.create(null,{meta:{value:{params:{frequency:{min:1,max:30,defaultValue:5,type:"float"},gain:{min:0,max:1,defaultValue:.6,type:"float"}}}},init:{value:function(){this.lfo.init()}},connect:{value:function(a){this.output.connect(a)}},disconnect:{value:function(){this.ouput.disconnect()}},frequency:{enumerable:!0,get:function(){return this.lfo.frequency},set:function(a){this.lfo.frequency=a}},gain:{enumerable:!0,get:function(){return this.ouput.gain.value},set:function(a){this.output.gain.setValueAtTime(a,0)}}}),b}]),angular.module("chunky").factory("Reverb",function(){var a=function(a){this.ctx=a,this.input=this.ctx.createGain(),this.node=this.ctx.createConvolver(),this.output=this.ctx.createGain(),this._dry=this.ctx.createGain(),this._wet=this.ctx.createGain(),this.output.gain.value=1,this._dry.gain.value=1,this._wet.gain.value=0,this._seconds=2,this._decay=2,this._reverse=0,this.input.connect(this.node),this.node.connect(this._wet),this._wet.connect(this.output),this.input.connect(this._dry),this._dry.connect(this.output),this.buildImpulse(),this.enabled=!1};return a.prototype=Object.create(null,{meta:{value:{params:{}}},connect:{value:function(a){this.output.connect(a)}},disconnect:{value:function(){this.output.disconnect()}},buildImpulse:{value:function(){var a,b,c=this.ctx.sampleRate,d=c*this._seconds,e=this._decay,f=this.ctx.createBuffer(2,d,c),g=f.getChannelData(0),h=f.getChannelData(1);for(b=0;d>b;b++)a=this._reverse?d-1:b,g[b]=(2*Math.random()-1)*Math.pow(1-a/d,e),h[b]=(2*Math.random()-1)*Math.pow(1-a/d,e);this.node.buffer=f}},toggleEnabled:{value:function(){this.enabled=!this.enabled,this.enabled?(this._dry.gain.value=.2,this._wet.gain.value=1):(this._dry.gain.value=1,this._wet.gain.value=0)}},seconds:{enumerable:!0,get:function(){return this._seconds},set:function(a){this._seconds=a,this.buildImpulse()}},decay:{enumerable:!0,get:function(){return this._decay},set:function(a){this._decay=a,this.buildImpulse()}}}),a}),angular.module("chunky").factory("Distortion",function(){var a=function(a){this.ctx=a,this.input=this.ctx.createGain(),this.output=this.ctx.createGain(),this.wet=this.ctx.createGain(),this.wet.gain.value=0,this.dry=this.ctx.createGain(),this.dry.gain.value=1,this.bandpass=this.ctx.createBiquadFilter(),this.bandpassWet=this.ctx.createGain(),this.bandpassDry=this.ctx.createGain(),this.waveShaper=this.ctx.createWaveShaper(),this.lowpass=this.ctx.createBiquadFilter(),this.input.connect(this.dry),this.input.connect(this.wet),this.wet.connect(this.bandpass),this.bandpass.connect(this.bandpassWet),this.bandpass.connect(this.bandpassDry),this.bandpassWet.connect(this.waveShaper),this.bandpassDry.connect(this.waveShaper),this.waveShaper.connect(this.lowpass),this.dry.connect(this.output),this.lowpass.connect(this.output),this.bandpass.frequency.value=800,this.bandpassWet.gain.value=.5,this.lowpass.frequency.value=3e3,this._drive=.5,this.bandpassDry.gain.value=.5,this.enabled=!1};return a.prototype=Object.create(null,{meta:{value:{params:{preBand:{min:0,max:1,defaultValue:.5,type:"float"},colour:{min:0,max:22050,defaultValue:800,type:"float"},drive:{min:0,max:1,defaultValue:.5,type:"float"},postCut:{min:0,max:22050,defaultValue:3e3,type:"float"}}}},connect:{value:function(a){this.output.connect(a.input?a.input:a)}},disconnect:{value:function(){this.output.disconnect()}},preBand:{enumerable:!0,get:function(){return this.bandpassWet.gain.value},set:function(a){this.bandpassWet.gain.setValueAtTime(a,0),this.bandpassDry.gain.setValueAtTime(1-a,0)}},colour:{enumerable:!0,get:function(){return this.bandpass.frequency.value},set:function(a){this.bandpass.frequency.setValueAtTime(a,0)}},drive:{enumerable:!0,get:function(){return this._drive},set:function(a){var b=100*a,c=22050,d=new Float32Array(c),e=Math.PI/180,f=0;for(this._drive=a,f;c>f;f++){var g=2*f/c-1;d[f]=(3+b)*g*20*e/(Math.PI+b*Math.abs(g))}}},postCut:{enumerable:!0,get:function(){return this.lowpass.frequency.value},set:function(a){this.lowpass.frequency.setValueAtTime(a,0)}},toggleEnabled:{value:function(){this.enabled=!this.enabled,this.enabled?(this.dry.gain.value=.4,this.wet.gain.value=1):(this.dry.gain.value=1,this.wet.gain.value=0)}}}),a});