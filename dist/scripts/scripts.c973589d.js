"use strict";angular.module("chunky",["ngRoute","ui.bootstrap","indexedDB"]).config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/main.html"}).otherwise({redirectTo:"/"})}]).controller("chunkyController",["$scope","chunkySynth",function(a,b){a.chunky=b,a.keyboard={keydown:function(b,c){a.chunky.playNote(b,c)},keyup:function(b,c){a.chunky.stop(b,c)}},a.overlay={toggled:!1,toggle:function(){a.overlay.toggled=!a.overlay.toggled}}}]),angular.module("chunky").directive("knob",["$document",function(a){return{restrict:"EA",replace:!0,template:'<div class="knob"><p data-ng-if="label" data-ng-bind="label" class="label"></p><div class="knob-face"><div class="knob-moving-face"><div class="knob-hand"></div></div></div><canvas class="knob-progress"></canvas></div>',scope:{value:"=",label:"@",options:"=",min:"=",max:"=",speed:"=",scale:"=",step:"="},link:function(b,c){function d(a){o.clickpos=a.pageY||a.originalEvent.targetTouches[0].pageY,o.focus=!0,o.initdeg=l.data("degs"),c.data("md",!0)}function e(a){var d=a.pageY||a.originalEvent.targetTouches[0].pageY,e=l.data("degs"),f=(o.clickpos-d)*h.speed,g=f*v+e;p>g&&g>q?e=g:g>p?e=p:q>g&&(e=q),e>q?c.addClass("turned-on"):c.removeClass("turned-on"),l.data("degs",e),l.css("-webkit-transform","rotate("+e+"deg)"),l.css("-moz-transform","rotate("+e+"deg)"),l.css("-ms-transform","rotate("+e+"deg)"),l.css("-o-transform","rotate("+e+"deg)"),l.css("transform","rotate("+e+"deg)");var i=l.data("degs")+p,j=Math.round(i/t*u);j+=h.min*u,j/=u,b.$apply(function(){b.value=parseFloat(j.toFixed(2))}),r=a.pageY||a.originalEvent.targetTouches[0].pageY,a.preventDefault()}function f(){o.focus=!1,l.data("md",!1)}b.options=b.options||{};var g={range:270,responsive:b.options.responsive||!1,min:b.min||b.options.min||0,max:b.max||b.options.max||100,speed:b.speed||b.options.speed||.5,scale:b.scale||b.step||b.options.scale||1,holdKey:!1,groupKey:!1},h=g,i=h.range/2,j=c,k=c.find(".knob-face"),l=k.find(".knob-moving-face"),m=l.find(".knob-hand"),n=j.find(".knob-progress");l.css("position","relative").css("overflow","hidden").css("float","none").css("-webkit-transform","rotate("+-i+"deg)").css("-moz-transform","rotate("+-i+"deg)").css("-ms-transform","rotate("+-i+"deg)").css("-o-transform","rotate("+-i+"deg)").css("transform","rotate("+-i+"deg)").data("degs",-i).data("value",0).data("md",!1).css("z-index","29"),k.css("float","none"),n.css("position","absolute").css("top",0).css("left",0).css("width",0).css("z-index","0"),h.responsive&&(j.addClass("knob-responsive"),k.css("height",k.width()));l.width()/2-m.width()/2;m.css("position","absolute").css("left","50%").css("height",l.innerHeight()/2);var o={},p=h.range/2,q=-1*p,r=0,s=h.max-h.min,t=h.range/s,u=1/h.scale,v=h.range/(h.max-h.min)*h.scale;o.clickPos=0,o.focus=!1,o.holdKey=!1,o.groupKey=!1,o.initDeg=0,l.on("touchstart",function(a){d(a)}),a.on("touchmove",function(a){o.focus&&(e(a,!0),b.$apply())}),a.on("touchend",function(){f()}),l.on("mousedown",function(a){d(a)}),a.on("mousemove",function(a){o.focus&&(e(a,!1),b.$apply())}),a.on("mouseup",function(){f()})}}}]),angular.module("chunky").directive("keyboard",["$window",function(a){return{restrict:"EA",scope:{keyup:"&",keydown:"&",polyphonic:"="},link:function(b,c){var d=new QwertyHancock({id:c.id,width:a.window.innerWidth,height:150,octaves:2,startNote:"C0"}),e={};d.keyDown=function(a,c){b.$apply(function(){b.keydown()(a,c),e[a]=!0})},d.keyUp=function(a,c){b.$apply(function(){delete e[a],b.polyphonic&&b.keyup()(a,c)})}}}}]),angular.module("chunky").directive("oscilloscope",function(){return{restrict:"EA",template:"<canvas></canvas>",replace:!0,scope:{analyser:"="},link:function(a,b){var c=(b.parent(),b[0]),d=c.getContext("2d"),e=a.analyser.fftSize,f=new Uint8Array(e);a.analyser.getByteTimeDomainData(f);var g=function(){requestAnimationFrame(g);a.analyser.getByteTimeDomainData(f),d.clearRect(0,0,c.width,c.height),d.fillStyle="rgba(115, 116, 137, 0)",d.fillRect(0,0,c.width,c.height),d.lineWidth=2,d.strokeStyle="rgba(115, 116, 137, 0.73)",d.beginPath();for(var b=2*c.width/e,h=0,i=0;e>i;i++){var j=f[i]/128,k=j*c.height/2;0===i?d.moveTo(h,k):d.lineTo(h,k),h+=b}d.lineTo(c.width,c.height/2),d.stroke()};g()}}}),angular.module("chunky").directive("fullscreen",function(){return{restrict:"A",link:function(a,b){console.log(b),b.requestFullscreen?b.requestFullscreen():b.msRequestFullscreen?b.msRequestFullscreen():b.mozRequestFullScreen?b.mozRequestFullScreen():b.webkitRequestFullscreen&&b.webkitRequestFullscreen()}}}),angular.module("chunky").directive("envelope",["$window",function(){return{restrict:"EA",template:"<canvas></canvas>",replace:!0,scope:{params:"=",inverted:"="},link:function(a,b){function c(){requestAnimationFrame(c);e.clearRect(0,0,f,g),e.lineWidth=2,e.beginPath(),a.inverted?(e.moveTo(h*(1-a.params.attack),0),e.lineTo(h,g),e.lineTo(h*(a.params.decay+1),g*(1-a.params.sustain)),e.lineTo(3*h,g*(1-a.params.sustain)),e.lineTo(h*(a.params.release+3),0)):(e.moveTo(h*(1-a.params.attack),g),e.lineTo(h,0),e.lineTo(h*(a.params.decay+1),g*(1-a.params.sustain)),e.lineTo(3*h,g*(1-a.params.sustain)),e.lineTo(h*(a.params.release+3),g)),e.strokeStyle="rgb(196,221,232)",e.stroke()}var d=b,e=(b.parent(),d[0].getContext("2d")),f=d[0].width,g=d[0].height,h=f/4;d.css("background-color","rgba(9,12,21,0.6)").css("border","1px solid rgb(57,64,72)"),c()}}}]),angular.module("chunky").directive("killRightClick",["$document",function(a){return{restrict:"CA",link:function(){a.on("contextmenu",function(){})}}}]),angular.module("chunky").service("chunkySynth",["audioCtx","Oscillator","Filter","Envelope","Distortion","Reverb","LFO","Noise","CombFilter","Patches","BitCrusher",function(a,b,c,d,e,f,g,h,i,j){var k=function(a){this.ctx=a,this.patches=j,this.polyphony=!0,this._glide={enabled:!0,amount:0},this._voices={},this.sampleRate=2048,this.osc1=new b(this.ctx,{shape:"sawtooth",octave:4,detune:-10}),this.osc2=new b(this.ctx,{shape:"sawtooth",octave:3,detune:10}),this.osc3=new b(this.ctx,{shape:"square",octave:1}),this.noise=new h(this.ctx),this.vcf=new c(this.ctx,{type:"bandpass"}),this.vcf2=new c(this.ctx,{type:"highpass"}),this.vcfEnvelope=new d(this.ctx),this.vcaEnvelope=new d(this.ctx),this.env1=new d(this.ctx),this.env2=new d(this.ctx),this.lfo1=new g(this.ctx),this.lfo2=new g(this.ctx),this.distortion=new e(this.ctx),this.reverb=new f(this.ctx),this.master=this.ctx.createGain(),this.analyser=this.ctx.createAnalyser(),this.oscs=[this.osc1,this.osc2,this.osc3,this.noise],this.filters=[this.vcf,this.vcf2],this.envelopes=[this.vcfEnvelope,this.vcaEnvelope,this.env1,this.env2],this.lfos=[],this.vcfMix=.5,this.analyser.fftSize=1024,this.master.gain.value=1,this.currentPatch=this.patches.list[0];for(var i=0;i<this.oscs.length;i++)this.oscs[i].connect(this.vcf.input),this.oscs[i].connect(this.vcf2.input);this.vcf.connect(this.distortion.input),this.vcf2.connect(this.distortion.input),this.distortion.connect(this.reverb),this.reverb.connect(this.master),this.master.connect(this.analyser),this.analyser.connect(this.ctx.destination),this.vcfEnvelope.connect(this.vcf,["_filter","frequency"]),this.vcfEnvelope.connect(this.vcf2,["_filter","frequency"]),this.vcaEnvelope.connect(this.master,"gain",{range:[0,2]}),this.lfo1.connect(this.vcf._filter.frequency),this.lfo1.connect(this.vcf2._filter.frequency),this.lfos.push(this.lfo1,this.lfo2)};return k.prototype=Object.create(null,{playNote:{value:function(a,b){var c,d,e=this.ctx.currentTime;for(this._voices[a]=b,d={note:a,frequency:b,now:this.ctx.currentTime},this.glide&&(d.glide=this.glideAmount),c=0;c<this.envelopes.length;c++)(!this.polyphony||!this.envelopes[c].reTrigger&&1===Object.keys(this._voices).length||this.envelopes[c].reTrigger)&&this.envelopes[c].triggerOn(e);for(c=0;c<this.oscs.length;c++){if(!this.polyphony)for(var f in this._voices)f!==a&&this.stop(f);this.oscs[c].start(d)}}},stop:{value:function(a,c){{var d;this.ctx.currentTime}if(this._voices[a]){for(delete this._voices[a],d=0;d<this.envelopes.length;d++)Object.keys(this._voices).length<=1;for(d=0;d<this.oscs.length;d++)this.oscs[d]instanceof b?this.oscs[d].stop(a,c):Object.keys(this._voices).length<1&&this.oscs[d].stop(a,c)}}},currentPatch:{get:function(){return this._currentPatch},set:function(a){this._currentPatch=a,this.loadPatch(a)}},loadPatch:{value:function(a){var c;for(c=0;c<this.oscs.length;c++)this.oscs[c]instanceof b?this.oscs[c].cfg=a.oscillators[c]:a.noise=this.oscs[c].cfg;for(this.noise.cfg=a.noise,this.vcfMix=a.vcfMix,c=0;c<this.filters.length;c++)this.filters[c].cfg=a.filters[c];for(c=0;c<this.envelopes.length;c++)this.envelopes[c].cfg=a.envelopes[c];for(c=0;c<this.lfos.length;c++)this.lfos[c].cfg=a.lfos[c];this.distortion.cfg=a.distortion,this.reverb.cfg=a.reverb}},savePatch:{value:function(){var a,c={oscillators:[],noise:{},filters:[],vcfMix:this.vcfmix,envelopes:[],lfos:[],distortion:this.distortion.cfg,reverb:this.reverb.cfg};for(a=0;a<this.oscs.length;a++)this.oscs[a]instanceof b?c.oscillators.push(this.oscs[a].cfg):c.noise=this.oscs[a].cfg;for(a=0;a<this.filters.length;a++)c.filters.push(this.filters[a].cfg);for(a=0;a<this.envelopes.length;a++)c.envelopes.push(this.envelopes[a].cfg);for(a=0;a<this.lfos.length;a++)c.lfos.push(this.lfos[a].cfg);return console.log(c),c}},vcfMix:{enumberable:!0,get:function(){return this._vcfMix},set:function(a){this._vcfMix=a,this.vcf.input.gain.value=parseFloat(a),this.vcf2.input.gain.value=parseFloat(1-a)}},masterGain:{enumberable:!0,get:function(){return this.master.gain.value},set:function(a){this.master.gain.setValueAtTime(a,0),this.master.envelope.range=[0,a]}},glide:{enumberable:!0,get:function(){return this._glide.enabled},set:function(a){this._glide.enabled=a}},glideAmount:{enumberable:!0,get:function(){return this._glide.amount},set:function(a){this._glide.amount=a}},polyphony:{enumberable:!0,get:function(){return this._polyphony},set:function(a){this._polyphony=a}},voices:{get:function(){return Object.keys(this._voices).length},set:function(){}}}),k.isEmpty=function(a){return 0===Object.keys(a).length},new k(a)}]),angular.module("chunky").service("Patches",function(){var a=function(){this.list=[{name:"init",oscillators:[{enabled:!0,shape:"sine",octave:4,fine:0,gain:.7},{enabled:!0,shape:"sine",octave:3,fine:0,gain:.9},{enabled:!0,shape:"sine",octave:2,fine:0,gain:.2}],vcfMix:.5,filters:[{enabled:!0,type:"lowpass",frequency:500,resonance:2,gain:1},{enabled:!1,type:"bandpass",frequency:500,resonance:2,gain:1}],envelopes:[{attack:.02,decay:.1,inverted:!1,reTrigger:!1,release:.02,sustain:1},{attack:.02,decay:.1,inverted:!1,reTrigger:!1,release:.02,sustain:1},{attack:.02,decay:.1,inverted:!1,reTrigger:!1,release:.02,sustain:1},{attack:.02,decay:.1,inverted:!1,reTrigger:!1,release:.02,sustain:1}],lfos:[{},{}],distortion:{enabled:!1,preBand:0,colour:0,drive:0,postCut:0},reverb:{enabled:!1,seconds:1,decay:.3}},{name:"sub",oscillators:[{enabled:!0,shape:"sine",octave:1,fine:0,gain:.7},{enabled:!1,shape:"sine",octave:3,fine:0,gain:.9},{enabled:!1,shape:"sine",octave:2,fine:0,gain:.2}],vcfMix:1,filters:[{enabled:!0,type:"lowpass",frequency:80,resonance:2,gain:1},{enabled:!1,type:"bandpass",frequency:500,resonance:2,gain:1}],envelopes:[{attack:2e-6,decay:2e-6,inverted:!0,reTrigger:!1,release:.02,sustain:1},{attack:.02,decay:.1,inverted:!1,reTrigger:!1,release:.02,sustain:1},{attack:.02,decay:.1,inverted:!1,reTrigger:!1,release:.02,sustain:1},{attack:.02,decay:.1,inverted:!1,reTrigger:!1,release:.02,sustain:1}],lfos:[{},{}],distortion:{enabled:!1,preBand:0,colour:0,drive:0,postCut:0},reverb:{enabled:!1,seconds:1,decay:.3}},{name:"sub backed",oscillators:[{enabled:!0,shape:"sine",octave:1,fine:0,gain:.7},{enabled:!0,shape:"sine",octave:3,fine:0,gain:.9},{enabled:!0,shape:"sine",octave:2,fine:0,gain:.2}],vcfMix:1,filters:[{enabled:!0,type:"lowpass",frequency:80,resonance:2,gain:1},{enabled:!1,type:"bandpass",frequency:500,resonance:2,gain:1}],envelopes:[{attack:2e-6,decay:2e-6,inverted:!0,reTrigger:!1,release:.02,sustain:1},{attack:.02,decay:.1,inverted:!1,reTrigger:!1,release:.02,sustain:1},{attack:.02,decay:.1,inverted:!1,reTrigger:!1,release:.02,sustain:1},{attack:.02,decay:.1,inverted:!1,reTrigger:!1,release:.02,sustain:1}],lfos:[{},{}],distortion:{enabled:!1,preBand:0,colour:0,drive:0,postCut:0},reverb:{enabled:!1,seconds:1,decay:.3}}],this.sync()};return a.prototype=Object.create(null,{register:{value:function(a){this.list.push(a)}},sync:{value:function(){}},_lookup:{value:function(){var a,b=[];for(a=0;a<this.list.length;a++)b.push({id:a,name:this.list[a].name});return b}},lookup:{get:function(){return this._lookup()}}}),new a}),angular.module("chunky").service("audioCtx",["$window",function(){var a=window.AudioContext||window.webkitAudioContext||window.mozAudioContext||window.oAudioContext||window.msAudioContext;return a?(a.prototype.createAudioWorker=function(a,b,c){return new AudioWorkerNode(this,a,b,c)},new a):void 0}]),angular.module("chunky").factory("Equalizer",function(){var a=function(a){this.ctx=a,this.bands=[],this.input=this.ctx.createGain(),this.output=this.ctx.createGain(),this.lowShelf=this.ctx.createBiquadFilter(),this.lowShelf.type="lowshelf",this.midShelf=this.ctx.createBiquadFilter(),this.midShelf.type="peaking",this.highShelf=this.ctx.createBiquadFilter(),this.highShelf.type="highshelf",this.registerBand(this.lowShelf),this.registerBand(this.midShelf),this.registerBand(this.highShelf),this.input.connect(this.lowShelf),this.lowShelf.connect(this.midShelf),this.midShelf.connect(this.highShelf),this.highShelf.connect(this.output)};return a.prototype=Object.create(null,{connect:{value:function(a){this.output.connect(a.input?a.input:a)}},disconnect:{value:function(){this.output.disconnect()}},registerBand:{value:function(a){this.bands.push(a)}}}),a}),angular.module("chunky").factory("BitCrusher",function(){var a=function(a,b){b=b||{},this.ctx=a,this.output=this.ctx.createGain(),this.input=this.ctx.createAudioWorker("scripts/services/bitcrusher-worker.js",1,1),this.input.addParameter("bits",b.bits||this.params.bits.defaultValue),this.input.addParameter("frequencyReduction",b.frequencyReduction||this.params.frequencyReduction.defaultValue),this.input.connect(this.output)};return a.prototype=Object.create(null,{params:{value:{bits:{name:"bits",labels:"BITS",min:1,max:512,defaultValue:512,type:"float"},frequencyReduction:{name:"frequencyReduction",label:"FR",min:0,max:1,defaultValue:.9,type:"float"}}},connect:{value:function(a){this.output.connect(a.input?a.input:a)}},disconnect:{value:function(){this.output.disconnect()}},bits:{enumerable:!0,get:function(){return this.worker.bits.value},set:function(a){this.worker.bits.value=a}},frequencyReduction:{enumerable:!0,get:function(){return this.worker.frequencyReduction.value},set:function(a){this.worker.frequencyReduction.value=a}}}),a}),angular.module("chunky").factory("FrequencyModulator",function(){var a=function(a,b){this.ctx=a,this.modulator=this.ctx.createOscillator(),this.amplifier=this.ctx.createGain(),this.output=this.ctx.createGain(),b=b||{},this.type=b.type||this.params.type.defaultValue,this.gain=b.gain||this.params.gain.defaultValue,this.frequency=b.frequency||this.params.frequency.defaultValue,this.modulator.connect(this.amplifier)};return a.prototype=Object.create(null,{connect:{value:function(a){this.amplifier.connect(a.input?a.input:a),this.modulator.start(0)}},disconnect:{value:function(){this.amplifier.disconnect()}},params:{value:{type:{type:"enum",_enum:["sine","saw","square","triangle"],defaultValue:"sine"},gain:{type:"float",min:0,max:70,defaultValue:30},frequency:{type:"float",min:0,max:1e4,defaultValue:400}}},type:{enumerable:!0,get:function(){return this.modulator.type},set:function(a){this.modulator.type=a}},gain:{enumerable:!0,get:function(){return this.amplifier.gain.value},set:function(a){this.amplifier.gain.setValueAtTime(a,0)}},frequency:{enumerable:!0,get:function(){return this.modulator.frequency.value},set:function(a){this.modulator.frequency.setValueAtTime(a,0)}},cfg:{get:function(){return{type:this.type,gain:this.gain,frequency:this.frequency}},set:function(a){this.type=a.type||this.type,this.gain=a.gain||this.gain,this.frequency=a.frequency||this.frequency}}}),a}),angular.module("chunky").factory("Oscillator",["FrequencyModulator",function(a){var b=function(a){return 0===Object.keys(a).length},c=function(a,b){b=b||{fm:{type:"sine",gain:300,frequency:400}},this.ctx=a,this.type="oscillator",this.voices={},this._fm=b.fm||{type:"sine",gain:300,frequency:400},this.controlNode=a.createGain(),this.node=this.ctx.createGain(),this.output=a.createGain(),this.frequency=b.frequency||55,this.octave=b.octave||2,this.fine=b.detune||0,this.shape=b.shape||"sine",this.controlNode.gain.value=.5,this.node.gain.value=0,this.output.gain.value=0,this.controlNode.connect(this.node),this.node.connect(this.output),this._enabled=!1};return c.prototype=Object.create(null,{connect:{value:function(a){this.output.connect(a.input?a.input:a)}},disconnect:{value:function(){this.output.disconnect()}},init:{value:function(){}},start:{value:function(b){this.frequency=b.frequency,this._fm.frequency=2*this.frequency;var c=new a(this.ctx,this._fm),d=this.ctx.createOscillator();d.fm=c,d.type=this.shape,d.frequency.setValueAtTime(this.frequency,b.now),d.detune.setValueAtTime(this.fine,b.now),c.connect(d.frequency),d.connect(this.controlNode),d.start(0),this.voices[b.note]=d,b.glide&&this._lastFrequency&&(d.frequency.setValueAtTime(this._lastFrequency,b.now),d.fm.modulator.frequency.setValueAtTime(2*this._lastFrequency,b.now),d.frequency.linearRampToValueAtTime(this.frequency,b.now+b.glide),d.fm.modulator.frequency.linearRampToValueAtTime(this._fm.frequency,b.now+b.glide)),this.output.gain.setValueAtTime(1,b.now),this._lastFrequency=this.frequency}},stop:{value:function(a){return this.voices[a].fm.disconnect(),this.voices[a].disconnect(),delete this.voices[a],b(this.voices)&&this.output.gain.setValueAtTime(0,0),this}},shape:{enumerable:!0,get:function(){return this._shape},set:function(a){this._shape=a}},frequency:{enumerable:!0,get:function(){return this._frequency},set:function(a){this._frequencyKey=a,this._frequency=Math.pow(2,this.octave)*this._frequencyKey}},octave:{enumerable:!0,get:function(){return this._octave},set:function(a){this._octave=a}},fine:{enumerable:!0,get:function(){return this._fine},set:function(a){this._fine=a}},gain:{enumerable:!0,get:function(){return this.controlNode.gain.value},set:function(a){this.controlNode.gain.setValueAtTime(a,0)}},enabled:{enumerable:!0,get:function(){return this._enabled},set:function(a){this._enabled=a,this._enabled?this.node.gain.setValueAtTime(1,0):this.node.gain.setValueAtTime(0,0)}},fmType:{enumerable:!0,get:function(){return this._fm.type},set:function(a){this._fm.type=a;for(var b in this.voices)this.voices[b].fm&&(this.voices[b].fm.type=this._fm.type)}},fmGain:{enumerable:!0,get:function(){return this._fm.gain},set:function(a){this._fm.gain=a;for(var b in this.voices)this.voices[b].fm.gain=this._fm.gain}},fmFrequency:{enumerable:!0,get:function(){return this._fm.frequency},set:function(a){this._fm.frequency=a;for(var b in this.voices)this.voices[b].fm.frequency=this.voices[b].frequency+this._fm.frequency}},cfg:{get:function(){return{enabled:this.enabled,shape:this.shape,octave:this.octave,fine:this.fine,gain:this.gain}},set:function(a){this.enabled=a.enabled,this.shape=a.shape,this.octave=a.octave,this.fine=a.fine,this.gain=a.gain}}}),c}]),angular.module("chunky").factory("Noise",function(){var a={white:function(a){var b,c;for(b=a.outputBuffer.getChannelData(0),c=0;c<b.length;c++)b[c]=2*Math.random()-1},pink:function(a){var b,c,d,e,f,g,h,i,j,k;for(b=c=d=e=f=g=h=0,i=a.outputBuffer.getChannelData(0),k=0;k<i.length;k++)j=2*Math.random()-1,b=.99886*b+.0555179*j,c=.99332*c+.0750759*j,d=.969*d+.153852*j,e=.8665*e+.3104856*j,f=.55*f+.5329522*j,g=-.7616*g-.016898*j,i[k]=b+c+d+e+f+g+h+.5362*j,i[k]*=.11,h=.115926*j},brown:function(a){var b,c,d,e;for(b=a.outputBuffer.getChannelData(0),d=0,e=0;e<b.length;e++)c=2*Math.random()-1,b[e]=(d+.02*c)/1.02,d=b[e],b[e]*=3.5}},b=function(b,c){c=c||{},this.ctx=b,this.type="noise",this.node=this.ctx.createScriptProcessor(2048,1,1),this._wet=this.ctx.createGain(),this._controlGain=this.ctx.createGain(),this.output=this.ctx.createGain(),this._enabled=!1,this._type=c.type||"white",this._wet.gain.value=0,this.output.gain.value=0,this.node.onaudioprocess=a[this._type],this.node.connect(this._wet),this._wet.connect(this._controlGain),this._controlGain.connect(this.output)};return b.prototype=Object.create(null,{connect:{value:function(a){this.output.connect(a)}},disconnect:{value:function(){this.output.disconnect()}},start:{value:function(){this.output.gain.setValueAtTime(1,0)}},stop:{value:function(){this.output.gain.setValueAtTime(0,0)}},gain:{enumerable:!0,get:function(){return this._controlGain.gain.value},set:function(a){this._controlGain.gain.setValueAtTime(a,0)}},enabled:{enumerable:!0,get:function(){return this._enabled},set:function(a){this._enabled=a,this._enabled?this._wet.gain.setValueAtTime(1,0):this._wet.gain.setValueAtTime(0,0)}},generator:{enumerable:!0,get:function(){return this._type},set:function(b){this._type=b,this.node.onaudioprocess=a[b]}},cfg:{get:function(){return{generator:this.generator,gain:this.gain}},set:function(a){this.generator=a.generator,this.gain=a.gain}}}),b.White=function(a){var c={};return c.onaudioprocess=function(a){var b,c;for(b=a.outputBuffer.getChannelData(0),c=0;c<b.length;c++)b[c]=2*Math.random()-1},new b(a,c)},b.Pink=function(a){var c={};return c.onaudioprocess=function(a){var b,c,d,e,f,g,h,i,j,k;for(b=c=d=e=f=g=h=0,i=a.outputBuffer.getChannelData(0),j=2*Math.random()-1,k=0;k<i.length;k++)b=.99886*b+.0555179*j,c=.99332*c+.0750759*j,d=.969*d+.153852*j,e=.8665*e+.3104856*j,f=.55*f+.5329522*j,g=-.7616*g-.016898*j,i[k]=b+c+d+e+f+g+h+.5362*j,i[k]*=.11,h=.115926*j},new b(a,c)},b.Brown=function(a){var c={};return c.onaudioprocess=function(a){var b,c,d,e;for(b=a.outputBuffer.getChannelData(0),c=2*Math.random()-1,d=0,e=0;e<b.length;e++)b[e]=(d+.02*c)/1.02,d=b[e],b[e]*=3.5},new b(a,c)},b}),angular.module("chunky").factory("CombFilter",function(){var a=function(a,b){this.ctx=a,this.input=this.ctx.createGain(),this._delay=this.ctx.createDelay(),this._damping=this.ctx.createGain(),this._filter=this.ctx.createBiquadFilter(),this._feedback=this.ctx.createGain(),this.output=this.ctx.createGain(),b=b||{},this.delay=b.delay||this.params.delay.defaultValue,this.feedback=b.feedback||this.params.feedback.defaultValue,this.damping=b.damping||this.params.damping.defaultValue,this.cuttoff=b.cuttoff||this.params.cuttoff.defaultValue,this.input.connect(this._delay),this._delay.connect(this._damping),this._damping.connect(this._filter),this._filter.connect(this._feedback),this._feedback.connect(this.input),this._damping.connect(this.output)};return a.prototype=Object.create(null,{params:{value:{delay:{label:"DLY",name:"delay",min:0,max:3,defaultValue:.027,step:.001},feedback:{label:"FDBK",name:"feedback",min:0,max:1,defaultValue:.84,step:.1},damping:{label:"DMP",name:"damping",min:0,max:1,defaultValue:.52,step:.01},cuttoff:{label:"DLY",name:"delay",min:0,max:22050,defaultValue:3e3,step:1}}},delay:{enumerable:!0,get:function(){return this._delay.delayTime.value},set:function(a){this._delay.delayTime.setValueAtTime(a,0)}},feedback:{enumerable:!0,get:function(){return this._feedback.gain.value},set:function(a){this._feedback.gain.setValueAtTime(a,0)}},damping:{enumerable:!0,get:function(){return this._damping.gain.value},set:function(a){this._damping.gain.setValueAtTime(a,0)}},cuttoff:{enumerable:!0,get:function(){return this._filter.frequency.value},set:function(a){this._filter.frequency.setValueAtTime(a,0)}},connect:{value:function(a){this.output.connect(a.input?a.input:a)}}}),a}),angular.module("chunky").factory("Filter",function(){var a=function(a,b){this.ctx=a,this.input=this.ctx.createGain(),this.output=this.ctx.createGain(),this._filter=this.ctx.createBiquadFilter(),this._dry=this.ctx.createGain(),this._wet=this.ctx.createGain();var c=this.meta.params;b=b||{},this.type=b.type||c.type.defaultValue,this.frequency=b.frequency||c.frequency.defaultValue,this.resonance=b.resonance||c.resonance.defaultValue,this.gain=b.gain||c.gain.defaultValue,this.wet=b.wet||c.wet.defaultValue,this.dry=b.dry||c.dry.defaultValue,this.input.connect(this._filter),this._filter.connect(this._wet),this._wet.connect(this.output),this.input.connect(this._dry),this._dry.connect(this.output),this._enabled=!0,this._envelope=void 0};return a.prototype=Object.create(null,{connect:{value:function(a){this.output.connect(a)}},disconnect:{value:function(){this.output.disconnect()}},meta:{value:{params:{frequency:{min:0,max:1e3,step:.5,defaultValue:.1,type:"float"},resonance:{min:0,max:40,defaultValue:0,type:"float"},gain:{min:-40,max:40,defaultValue:1,type:"float"},wet:{min:0,max:1,defaultValue:1,type:"float"},dry:{min:0,max:1,defaultValue:0,type:"float"}}}},envelope:{enumerable:!0,get:function(){return this._envelope},set:function(a){this._envelope=a,this._envelope.range=[30,this._frequency]}},type:{enumerable:!0,get:function(){return this._filter.type},set:function(a){this._filter.type=a}},frequency:{enumerable:!0,get:function(){return this._filter.frequency.value},set:function(a){this._frequency=25e3*Math.pow(a/1e3,2)+30,this._filter.frequency.setValueAtTime(this._frequency,0),this._envelope&&this._envelope.range&&(this._envelope.range=[30,this._frequency])}},resonance:{enumerable:!0,get:function(){return this._filter.Q.value},set:function(a){this._filter.Q.setValueAtTime(a,0)}},gain:{enumerable:!0,get:function(){return this._filter.gain.value},set:function(a){this._filter.gain.setValueAtTime(a,0)}},wet:{enumerable:!0,get:function(){return this._wet.gain.value},set:function(a){this._wet.gain.setValueAtTime(a,0)}},dry:{enumerable:!0,get:function(){return this._dry.gain.value},set:function(a){this._dry.gain.setValueAtTime(a,0)}},enabled:{enumerable:!0,get:function(){return this._enabled},set:function(a){this._enabled=a,this._enabled?(this._dry.gain.setValueAtTime(0,0),this._wet.gain.setValueAtTime(1,0)):(this._dry.gain.setValueAtTime(1,0),this._wet.gain.setValueAtTime(0,0))}},cfg:{get:function(){return{type:this.type,frequency:this.frequency,resonance:this.resonance,gain:this.gain}},set:function(a){this.type=a.type,this.frequency=a.frequency,this.resonance=a.resonance,this.gain=a.gain}}}),a}),angular.module("chunky").factory("EnvelopeParam",function(){var a=function(a){this.parent=a.parent||null,this.target=a.target||null,this.meta=a.meta||{},this.range=this.meta.range||this.params.range.defaultValue};return a.prototype=Object.create(null,{range:{get:function(){return[this.min,this.max]},set:function(a){this.min=parseFloat(a[0]),this.max=parseFloat(a[1])}},params:{value:{range:{defaultValue:[0,100]}}}}),a}),angular.module("chunky").factory("Envelope",["EnvelopeParam",function(a){var b=function(a,b){b=b||{},this.ctx=a,this.name=b.name||"ENV",this.attack=b.attack||1e3,this.decay=b.decay||5e4,this.sustain=b.sustain||100,this.release=b.release||1e3,this.inverted=b.inverted||!1,this.reTrigger=b.reTrigger||!1,this.targets=[]};return b.prototype=Object.create(null,{params:{value:{attack:{name:"attack",label:"ATK",min:0,max:5e4},decay:{name:"decay",label:"DCY",min:0,max:5e4},sustain:{name:"sustain",label:"SUS",min:0,max:100},release:{name:"release",label:"REL",min:0,max:5e4}}},connect:{value:function(b,c,d){var e;e=angular.isArray(c)?b[c[0]][c[1]]:b[c];var f=new a({parent:b,target:e,meta:d});return b.envelope=f,this.targets.push(f),f}},attack:{get:function(){return this._attack},set:function(a){this._attack=parseFloat(a/5e4)}},decay:{get:function(){return this._decay},set:function(a){this._decay=parseFloat(a/5e4)}},sustain:{get:function(){return this._sustain},set:function(a){this._sustain=parseFloat(a/100)}},release:{get:function(){return this._release},set:function(a){this._release=parseFloat(a/5e4)}},inverted:{enumerable:!0,get:function(){return this._inverted},set:function(a){this._inverted=a}},reTrigger:{enumerable:!0,get:function(){return this._retrig},set:function(a){this._retrig=a}},triggerOn:{value:function(a){for(var b=0;b<this.targets.length;b++)this.processTriggerOn(this.targets[b],a)}},processTriggerOn:{value:function(a,b){this.inverted?(a.target.cancelScheduledValues(b),a.target.setValueAtTime(a.max,b),a.target.linearRampToValueAtTime(a.min,b+this.attack),a.target.linearRampToValueAtTime(this.sustain*(a.min-a.max)+a.max,b+this.attack+this.decay)):(a.target.cancelScheduledValues(b),a.target.setValueAtTime(a.min,b),a.target.linearRampToValueAtTime(a.max,b+this.attack),a.target.linearRampToValueAtTime(this.sustain*(a.max-a.min)+a.min,b+this.attack+this.decay))}},triggerOff:{value:function(a){for(var b=0;b<this.targets.length;b++)this.targets[b].target.linearRampToValueAtTime(0,a+this.release),this.targets[b].target.linearRampToValueAtTime(0,a+this.release+.01),this.targets[b].target.cancelScheduledValues(0,a+this.release+.02)}},cfg:{get:function(){return{attack:this.attack,decay:this.decay,sustain:this.sustain,release:this.release,reTrigger:this.reTrigger,inverted:this.inverted}},set:function(a){this._attack=a.attack,this._decay=a.decay,this._sustain=a.sustain,this._release=a.release,this.reTrigger=a.reTrigger,this.inverted=a.inverted}}}),b}]),angular.module("chunky").factory("LFO",["Oscillator",function(){var a=function(a,b){b=b||{},this.ctx=a,this.lfo=this.ctx.createOscillator(),this.lfo.start(0),this.lfo.frequency.value=b.frequency||this.params.frequency.defaultValue,this.output=a.createGain(),this.output.gain.value=b.gain||this.params.gain.defaultValue,this.lfo.connect(this.output)};return a.prototype=Object.create(null,{params:{value:{frequency:{name:"frequency",label:"FREQ",min:1,step:.01,max:20,defaultValue:5,type:"float"},gain:{name:"gain",label:"AMT",min:0,step:1,max:100,defaultValue:20,type:"float"}}},connect:{value:function(a){this.output.connect(a)}},disconnect:{value:function(){this.ouput.disconnect()}},frequency:{enumerable:!0,get:function(){return this.lfo.frequency.value},set:function(a){console.log(a),this.lfo.frequency.setValueAtTime(a,0)}},gain:{enumerable:!0,get:function(){return this.output.gain.value},set:function(a){console.log(a),this.output.gain.setValueAtTime(a,0)}}}),a}]),angular.module("chunky").factory("Reverb",function(){var a=function(a){this.ctx=a,this.input=this.ctx.createGain(),this.node=this.ctx.createConvolver(),this.output=this.ctx.createGain(),this._dry=this.ctx.createGain(),this._wet=this.ctx.createGain(),this.output.gain.value=1,this._dry.gain.value=1,this._wet.gain.value=0,this._seconds=2,this._decay=2,this._reverse=0,this.input.connect(this.node),this.node.connect(this._wet),this._wet.connect(this.output),this.input.connect(this._dry),this._dry.connect(this.output),this.buildImpulse(),this.enabled=!1};return a.prototype=Object.create(null,{meta:{value:{params:{}}},connect:{value:function(a){this.output.connect(a)}},disconnect:{value:function(){this.output.disconnect()}},buildImpulse:{value:function(){var a,b,c=this.ctx.sampleRate,d=c*this._seconds,e=this._decay,f=this.ctx.createBuffer(2,d,c),g=f.getChannelData(0),h=f.getChannelData(1);for(b=0;d>b;b++)a=this._reverse?d-1:b,g[b]=(2*Math.random()-1)*Math.pow(1-a/d,e),h[b]=(2*Math.random()-1)*Math.pow(1-a/d,e);this.node.buffer=f}},toggleEnabled:{value:function(){this.enabled=!this.enabled,this.enabled?(this._dry.gain.value=.2,this._wet.gain.value=1):(this._dry.gain.value=1,this._wet.gain.value=0)}},seconds:{enumerable:!0,get:function(){return this._seconds},set:function(a){this._seconds=a,this.buildImpulse()}},decay:{enumerable:!0,get:function(){return this._decay},set:function(a){this._decay=a,this.buildImpulse()}},cfg:{get:function(){return{enabled:this.enabled,seconds:this.seconds,decay:this.decay}},set:function(a){this.decay=a.decay,this.seconds=a.seconds,this.decay=a.decay}}}),a}),angular.module("chunky").factory("Distortion",function(){var a=function(a){this.ctx=a,this.input=this.ctx.createGain(),this.output=this.ctx.createGain(),this.wet=this.ctx.createGain(),this.wet.gain.value=0,this.dry=this.ctx.createGain(),this.dry.gain.value=1,this.bandpass=this.ctx.createBiquadFilter(),this.bandpassWet=this.ctx.createGain(),this.bandpassDry=this.ctx.createGain(),this.waveShaper=this.ctx.createWaveShaper(),this.lowpass=this.ctx.createBiquadFilter(),this.input.connect(this.dry),this.input.connect(this.wet),this.wet.connect(this.bandpass),this.bandpass.connect(this.bandpassWet),this.bandpass.connect(this.bandpassDry),this.bandpassWet.connect(this.waveShaper),this.bandpassDry.connect(this.waveShaper),this.waveShaper.connect(this.lowpass),this.dry.connect(this.output),this.lowpass.connect(this.output),this.bandpass.frequency.value=800,this.bandpassWet.gain.value=.5,this.lowpass.frequency.value=3e3,this._drive=.5,this.bandpassDry.gain.value=.5,this.enabled=!1
};return a.prototype=Object.create(null,{meta:{value:{params:{preBand:{min:0,max:1,defaultValue:.5,type:"float"},colour:{min:0,max:22050,defaultValue:800,type:"float"},drive:{min:0,max:1,defaultValue:.5,type:"float"},postCut:{min:0,max:22050,defaultValue:3e3,type:"float"}}}},connect:{value:function(a){this.output.connect(a.input?a.input:a)}},disconnect:{value:function(){this.output.disconnect()}},preBand:{enumerable:!0,get:function(){return this.bandpassWet.gain.value},set:function(a){this.bandpassWet.gain.setValueAtTime(a,0),this.bandpassDry.gain.setValueAtTime(1-a,0)}},colour:{enumerable:!0,get:function(){return this.bandpass.frequency.value},set:function(a){this.bandpass.frequency.setValueAtTime(a,0)}},drive:{enumerable:!0,get:function(){return this._drive},set:function(a){var b=100*a,c=22050,d=new Float32Array(c),e=Math.PI/180,f=0;for(this._drive=a,f;c>f;f++){var g=2*f/c-1;d[f]=(3+b)*g*20*e/(Math.PI+b*Math.abs(g))}}},postCut:{enumerable:!0,get:function(){return this.lowpass.frequency.value},set:function(a){this.lowpass.frequency.setValueAtTime(a,0)}},toggleEnabled:{value:function(){this.enabled=!this.enabled,this.enabled?(this.dry.gain.value=.4,this.wet.gain.value=1):(this.dry.gain.value=1,this.wet.gain.value=0)}},cfg:{get:function(){return{enabled:this.enabled,preBand:this.preBand,colour:this.colour,drive:this.drive,postCut:this.postCut}},set:function(a){this.enabled=a.enabled,this.preBand=a.preBand,this.colour=a.colour,this.drive=a.drive,this.postCut=a.postCut}}}),a});